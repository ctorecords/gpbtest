# GPBExim Parser & UI

## Описание задачи

Проект реализует разбор Exim-логов, сохранение данных в БД и предоставление поискового интерфейса по email-адресам.  
Реализация ориентирована на использование в рамках тестового задания, но масштабируема под большие объёмы логов.

---

## Структура проекта

- `bin/parselog.pl` — парсинг и индексация логов.
- `bin/webserver.pl` — запуск HTTP-интерфейса.
- `lib/GPBExim/` — основная логика разбора и UI.
- `t/` — юнит-тесты (на SQLite, но можно включить через t/config.yml и MySQL).
- `config.yml` — конфигурация, включая параметры БД, путей и настроек индексации (для тестов своя - t/config.yml).
- `xapian/` — директория индекса поиска по e-mail адресам, создаётся при первом запуске.

---

## Допущения и спорные места в постановке задания

В тестовом задании допущен ряд неоднозначностей. В реализации сделаны следующие **допущения**:

1. **Флаг `<=` без адреса**: строки вида  
   `2012-02-13 14:39:22 1RwtJa-000AGs-7A <= <> ...`  
   — являются bounce-сообщениями (отказами).  
   Поскольку в таких строках отсутствует `id=...`, вставка в `message` невозможна из-за ограничения `NOT NULL PRIMARY KEY`.  
   (Такие сообщения записываются в отдельную таблицу `message_bounce`, но ни где не выводятся).

2. **Поле `status` в таблице `message`** не описано в ТЗ.  
   (В текущей реализации оно не используется и всегда устанавливается в `NULL`).

3. **Поле `address` в таблице `log`**:  
   указание адреса не всегда возможно — в некоторых строках (например, флаги `Completed`) он отсутствует.  
   (В таких случаях поле остаётся `NULL`).

4. **Формат поля `created`**:  
   предполагается парсинг в `TIMESTAMP` с точностью до секунд.  
   (В `SQLite` используется `TEXT` с преобразованием через `strftime`).

5. **Объём данных**:  
   реализация ориентирована на большие лог-файлы.  
   (Чтение организовано по чанкам с размером 1 ГБ, буферизация и обработка — по границам `\n`).

6. **Поиск по email**:  
   осуществляется через Xapian-индекс по n-граммам.  
   (Поддерживается suggest (автодополнение) и поиск).

---

## Использование

### 1. Установка зависимостей

Перед установкой убедитесь, что установлены:

```bash
sudo apt install libdbi-perl libdbd-sqlite3-perl libdbd-mysql-perl libtemplate-perl libhttp-message-perl libwww-perl libsearch-xapian-perl libxapian-dev libmysqlclient-dev build-essential

````

Перловые модули:

```bash
cpanm -fn \
  YAML::XS JSON::XS lib::abs uni::perl Try::Tiny \
  Config::Any Scalar::Util::Numeric \
  Log::Any Log::Any::Adapter Log::Log4perl \
  Log::Any::Adapter::Log4perl Log::Log4perl::Layout::JSON

```

---

### 2. Конфигурация

Дефолтное состояние конфигов готов к работе из коробки в файлах `./config.yml` и `./t/config.yml`

Важно убедиться, что доступы к MySQL в ./config.yml были рабочими. Проверка того, что конфигурация прописана корректно: 

```bash
bin/testconn.pl

````


---

### 3. Установка

```bash
perl Makefile.PL
```

---

### 4. Прогон тестов

```bash
prove t/
```

По умолчанию тесты используют SQLite в памяти (`SQLite3::Memory`) или файл.

Для тестов с MySQL можно настроить `t/config.yml`. 

---

### 5. Парсинг логов

```bash
bin/parselog.pl temp/maillog
```

Путь к логу специально не введён ни в какие конфиги, так как источник данных всегда надо точно указывать. 

---

### 6. Запуск веб-интерфейса

```bash
bin/webserver.pl
# или с указанием порта:
bin/webserver.pl -p 8081
```

---

## Интерфейс

* Форма с одним текстовым полем поиска по email.
* Поддерживает:

  * suggest при вводе (подсвечивает введённую строку)
  * отображение логов по найденным email (подсвечивает строку по которой идёт поиск)
  * ограничение вывода 100 строками (с сообщением при превышении) - это ограничение конфигурируется в `config.yml`

---

## Архитектура тестирования

* TDD-подход: каждый модуль покрыт тестами.
* Проверяются:

  * парсинг строк
  * буферизация чанков
  * загрузка в БД
  * индексация
  * поиск по email
* Используется SQLite (in-memory и file)
* Кросс-БД поведение проверяется через конфиг

---

## Структура хранения bounce

Дополнительно добавлены таблицы:

* `message_address` — нормализованные email-адреса
* `message_bounce` — события отказов

---

## Ссылки

* Код: [https://github.com/ctorecords/gpbtest](https://github.com/ctorecords/gpbtest)
* Видео-демонстрация интерфейса: [Яндекс.Диск](https://disk.yandex.ru/i/DbkGlt9ZH-eYSw)

---

## Обратная связь

Буду признателен получить обратную связь на `dsimonov2@yandex.ru`. Заранее спасибо!

