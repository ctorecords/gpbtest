use Test::More;
use lib::abs '../lib';
use uni::perl ':dumper';
use Try::Tiny;
use HTTP::Request;
use JSON::XS;
use GPBExim::Test qw(test_search test_parse_logfile cq);


my $rows = [
  { int_id => "1QIIgl-000F1c-JL", o_id => 3662, t => "log", created => "2012-02-13 14:49:31", str => '1QIIgl-000F1c-JL ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QIKLq-000KB4-DB", o_id => 3058, t => "log", created => "2012-02-13 14:49:16", str => '1QIKLq-000KB4-DB ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QN0p8-000MTa-JW", o_id => 3690, t => "log", created => "2012-02-13 14:49:31", str => '1QN0p8-000MTa-JW ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QTLsC-000LHz-VW", o_id => 3660, t => "log", created => "2012-02-13 14:49:31", str => '1QTLsC-000LHz-VW ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QTXe4-0006SI-7A", o_id => 4397, t => "log", created => "2012-02-13 14:49:48", str => '1QTXe4-0006SI-7A ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QTYLU-000Nic-SN", o_id => 3073, t => "log", created => "2012-02-13 14:49:16", str => '1QTYLU-000Nic-SN ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QWR0x-000M8z-R2", o_id => 3262, t => "log", created => "2012-02-13 14:49:19", str => '1QWR0x-000M8z-R2 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QWR5R-0001oF-KJ", o_id => 9370, t => "log", created => "2012-02-13 15:09:41", str => '1QWR5R-0001oF-KJ ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QWSYS-0007eO-1p", o_id => 8668, t => "log", created => "2012-02-13 15:09:21", str => '1QWSYS-0007eO-1p ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QXOpx-000N54-42", o_id => 4535, t => "log", created => "2012-02-13 14:49:50", str => '1QXOpx-000N54-42 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Qb97J-0003a4-Qa", o_id => 3589, t => "log", created => "2012-02-13 14:49:30", str => '1Qb97J-0003a4-Qa ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QdsAl-0000LR-P9", o_id => 4117, t => "log", created => "2012-02-13 14:49:40", str => '1QdsAl-0000LR-P9 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Qe6qC-000Gxl-Bf", o_id => 3991, t => "log", created => "2012-02-13 14:49:39", str => '1Qe6qC-000Gxl-Bf ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QeewW-000NyX-Lf", o_id => 3243, t => "log", created => "2012-02-13 14:49:19", str => '1QeewW-000NyX-Lf ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QgFD4-000L0x-DQ", o_id => 4497, t => "log", created => "2012-02-13 14:49:49", str => '1QgFD4-000L0x-DQ ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QhLKk-000ApW-GJ", o_id => 814, t => "log", created => "2012-02-13 14:39:46", str => '1QhLKk-000ApW-GJ ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Qikk3-0009ay-IV", o_id => 4114, t => "log", created => "2012-02-13 14:49:40", str => '1Qikk3-0009ay-IV ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QilWs-0009Z0-Kr", o_id => 889, t => "log", created => "2012-02-13 14:39:48", str => '1QilWs-0009Z0-Kr ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QkNyJ-00059o-Tj", o_id => 3269, t => "log", created => "2012-02-13 14:49:19", str => '1QkNyJ-00059o-Tj ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QmNaZ-0007SS-Vk", o_id => 4153, t => "log", created => "2012-02-13 14:49:40", str => '1QmNaZ-0007SS-Vk ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QmNuE-000BRd-84", o_id => 435, t => "log", created => "2012-02-13 14:39:32", str => '1QmNuE-000BRd-84 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1QmONC-000AzU-Vq", o_id => 3240, t => "log", created => "2012-02-13 14:49:19", str => '1QmONC-000AzU-Vq ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1ROawJ-0008hk-8h", o_id => 4129, t => "log", created => "2012-02-13 14:49:40", str => '1ROawJ-0008hk-8h ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RPvHS-0002ee-7U", o_id => 8747, t => "log", created => "2012-02-13 15:09:23", str => '1RPvHS-0002ee-7U ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RQcu8-000BBi-F6", o_id => 3982, t => "log", created => "2012-02-13 14:49:39", str => '1RQcu8-000BBi-F6 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RSShJ-000LQD-3L", o_id => 3905, t => "log", created => "2012-02-13 14:49:37", str => '1RSShJ-000LQD-3L ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RTXVG-000DQz-CP", o_id => 4540, t => "log", created => "2012-02-13 14:49:50", str => '1RTXVG-000DQz-CP ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RU60J-000KYQ-2h", o_id => 3984, t => "log", created => "2012-02-13 14:49:39", str => '1RU60J-000KYQ-2h ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RV0tx-0005S1-9t", o_id => 3897, t => "log", created => "2012-02-13 14:49:37", str => '1RV0tx-0005S1-9t ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RV0tx-0005S1-Cd", o_id => 3980, t => "log", created => "2012-02-13 14:49:39", str => '1RV0tx-0005S1-Cd ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RW54x-000JTG-7g", o_id => 3061, t => "log", created => "2012-02-13 14:49:16", str => '1RW54x-000JTG-7g ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RYbdU-000EhS-9a", o_id => 3071, t => "log", created => "2012-02-13 14:49:16", str => '1RYbdU-000EhS-9a ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RYbnJ-000GY6-5y", o_id => 4538, t => "log", created => "2012-02-13 14:49:50", str => '1RYbnJ-000GY6-5y ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RYcLZ-000C1I-5P", o_id => 3901, t => "log", created => "2012-02-13 14:49:37", str => '1RYcLZ-000C1I-5P ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RYd7U-000599-SO", o_id => 4141, t => "log", created => "2012-02-13 14:49:40", str => '1RYd7U-000599-SO ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RYdCU-000AKQ-7q", o_id => 3926, t => "log", created => "2012-02-13 14:49:38", str => '1RYdCU-000AKQ-7q ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RYdCU-000AKQ-DM", o_id => 3988, t => "log", created => "2012-02-13 14:49:39", str => '1RYdCU-000AKQ-DM ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RZxUz-0002Ve-Hi", o_id => 9019, t => "log", created => "2012-02-13 15:09:31", str => '1RZxUz-0002Ve-Hi ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Ra4FU-000Pcg-R4", o_id => 3656, t => "log", created => "2012-02-13 14:49:31", str => '1Ra4FU-000Pcg-R4 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Ra4Fx-000Pcg-Ou", o_id => 4155, t => "log", created => "2012-02-13 14:49:40", str => '1Ra4Fx-000Pcg-Ou ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rb8fJ-0008Dn-99", o_id => 3723, t => "log", created => "2012-02-13 14:49:32", str => '1Rb8fJ-0008Dn-99 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rb9cu-00013w-E3", o_id => 3077, t => "log", created => "2012-02-13 14:49:16", str => '1Rb9cu-00013w-E3 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rb9ul-0008V2-SS", o_id => 3986, t => "log", created => "2012-02-13 14:49:39", str => '1Rb9ul-0008V2-SS ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rb9um-0008V2-Kq", o_id => 362, t => "log", created => "2012-02-13 14:39:31", str => '1Rb9um-0008V2-Kq ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rb9vW-000AzQ-5O", o_id => 3267, t => "log", created => "2012-02-13 14:49:19", str => '1Rb9vW-000AzQ-5O ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RbAO8-000I7i-KO", o_id => 3899, t => "log", created => "2012-02-13 14:49:37", str => '1RbAO8-000I7i-KO ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RcbfZ-0008Dg-5W", o_id => 3559, t => "log", created => "2012-02-13 14:49:30", str => '1RcbfZ-0008Dg-5W ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RccRs-000Lhd-Al", o_id => 454, t => "log", created => "2012-02-13 14:39:32", str => '1RccRs-000Lhd-Al ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rdg1P-000AXn-9l", o_id => 8722, t => "log", created => "2012-02-13 15:09:22", str => '1Rdg1P-000AXn-9l ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rdg28-000Bgz-5x", o_id => 4131, t => "log", created => "2012-02-13 14:49:40", str => '1Rdg28-000Bgz-5x ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rf84W-000Oub-2Z", o_id => 4144, t => "log", created => "2012-02-13 14:49:40", str => '1Rf84W-000Oub-2Z ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rf8Nl-0001C4-Lm", o_id => 3893, t => "log", created => "2012-02-13 14:49:37", str => '1Rf8Nl-0001C4-Lm ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rf8Xl-0008bW-Dp", o_id => 3075, t => "log", created => "2012-02-13 14:49:16", str => '1Rf8Xl-0008bW-Dp ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RgDQm-000Ded-Bt", o_id => 469, t => "log", created => "2012-02-13 14:39:32", str => '1RgDQm-000Ded-Bt ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RgDu8-000EuW-T9", o_id => 4139, t => "log", created => "2012-02-13 14:49:40", str => '1RgDu8-000EuW-T9 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RgE7s-000Bou-TJ", o_id => 364, t => "log", created => "2012-02-13 14:39:31", str => '1RgE7s-000Bou-TJ ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rgbh3-0003ZY-Or", o_id => 3669, t => "log", created => "2012-02-13 14:49:31", str => '1Rgbh3-0003ZY-Or ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RiILq-0008ER-Lq", o_id => 3237, t => "log", created => "2012-02-13 14:49:19", str => '1RiILq-0008ER-Lq ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rkx7Z-0000YM-BF", o_id => 3977, t => "log", created => "2012-02-13 14:49:39", str => '1Rkx7Z-0000YM-BF ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RlJ2m-000J0n-Dd", o_id => 243, t => "log", created => "2012-02-13 14:39:30", str => '1RlJ2m-000J0n-Dd ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RlJQx-000AfA-U7", o_id => 4135, t => "log", created => "2012-02-13 14:49:40", str => '1RlJQx-000AfA-U7 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rm0kE-00027I-IY", o_id => 11, t => "log", created => "2012-02-13 14:39:22", str => '1Rm0kE-00027I-IY ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RmEkZ-000Q0F-C6", o_id => 3272, t => "log", created => "2012-02-13 14:49:20", str => '1RmEkZ-000Q0F-C6 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RmNhC-0002Ue-I4", o_id => 4124, t => "log", created => "2012-02-13 14:49:40", str => '1RmNhC-0002Ue-I4 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RmkP8-0006ce-TP", o_id => 3059, t => "log", created => "2012-02-13 14:49:16", str => '1RmkP8-0006ce-TP ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rnpc3-0001rT-E7", o_id => 3974, t => "log", created => "2012-02-13 14:49:39", str => '1Rnpc3-0001rT-E7 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RnqhW-000MSR-1G", o_id => 3069, t => "log", created => "2012-02-13 14:49:16", str => '1RnqhW-000MSR-1G ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RnqhZ-000MSR-Lw", o_id => 3065, t => "log", created => "2012-02-13 14:49:16", str => '1RnqhZ-000MSR-Lw ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RookS-000Pg8-VO", o_id => 4, t => "log", created => "2012-02-13 14:39:22", str => '1RookS-000Pg8-VO ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RpA7C-00027t-8H", o_id => 3895, t => "log", created => "2012-02-13 14:49:37", str => '1RpA7C-00027t-8H ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RpJE3-0007cy-1P", o_id => 3903, t => "log", created => "2012-02-13 14:49:37", str => '1RpJE3-0007cy-1P ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RpJSl-0008h8-Iz", o_id => 3275, t => "log", created => "2012-02-13 14:49:20", str => '1RpJSl-0008h8-Iz ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RpvUs-000Hvw-Ru", o_id => 241, t => "log", created => "2012-02-13 14:39:30", str => '1RpvUs-000Hvw-Ru ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RqOBz-000HDl-Sd", o_id => 9384, t => "log", created => "2012-02-13 15:09:41", str => '1RqOBz-000HDl-Sd ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RqavC-000HeI-Jo", o_id => 4502, t => "log", created => "2012-02-13 14:49:49", str => '1RqavC-000HeI-Jo ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RqawC-000Li4-6R", o_id => 3063, t => "log", created => "2012-02-13 14:49:16", str => '1RqawC-000Li4-6R ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RqlIW-000E2U-5z", o_id => 3553, t => "log", created => "2012-02-13 14:49:30", str => '1RqlIW-000E2U-5z ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RtsYW-000KMr-VV", o_id => 4151, t => "log", created => "2012-02-13 14:49:40", str => '1RtsYW-000KMr-VV ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RtsxW-0001n9-Fr", o_id => 3664, t => "log", created => "2012-02-13 14:49:31", str => '1RtsxW-0001n9-Fr ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RudCP-000OXa-2a", o_id => 8601, t => "log", created => "2012-02-13 15:09:20", str => '1RudCP-000OXa-2a ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RuizJ-000CrM-Om", o_id => 3067, t => "log", created => "2012-02-13 14:49:16", str => '1RuizJ-000CrM-Om ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rujbz-000JT7-S2", o_id => 8704, t => "log", created => "2012-02-13 15:09:22", str => '1Rujbz-000JT7-S2 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RujgP-000DK8-OJ", o_id => 9043, t => "log", created => "2012-02-13 15:09:31", str => '1RujgP-000DK8-OJ ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rujzc-00025m-V0", o_id => 6218, t => "log", created => "2012-02-13 14:59:20", str => '1Rujzc-00025m-V0 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Ruk4W-000K9E-MA", o_id => 3079, t => "log", created => "2012-02-13 14:49:16", str => '1Ruk4W-000K9E-MA ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rv6wU-0000vm-95", o_id => 3265, t => "log", created => "2012-02-13 14:49:19", str => '1Rv6wU-0000vm-95 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1Rv7MZ-0003R4-T6", o_id => 3677, t => "log", created => "2012-02-13 14:49:31", str => '1Rv7MZ-0003R4-T6 ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RvKqx-000N7x-5x", o_id => 3695, t => "log", created => "2012-02-13 14:49:31", str => '1RvKqx-000N7x-5x ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
  { int_id => "1RvLAE-0001RQ-7W", o_id => 9038, t => "log", created => "2012-02-13 15:09:31", str => '1RvLAE-0001RQ-7W ** fwxvparobkymnbyemevz@london.com: retry timeout exceeded' },
];

test_parse_logfile('Разбор длинного предоставленного файла' => lib::abs::path('../temp/maillog'), {
  "fwxvparobkymnbyemevz\@london.com" => { data => $rows }
} );

done_testing;